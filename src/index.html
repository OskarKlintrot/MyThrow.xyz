<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, shrink-to-fit=no"
    />

    <title>My Throw</title>

    <link rel="canonical" href="https://mythrow.xyz/" />

    <meta name="application-name" content="My Throw" />
    <meta name="msapplication-tooltip" content="My Throw" />
    <meta name="msapplication-starturl" content="/" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/favicon/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/favicon/favicon-16x16.png"
    />
    <link rel="manifest" href="/site.webmanifest" />

    <meta name="color-scheme" content="light dark" />
    <meta
      name="theme-color"
      media="(prefers-color-scheme: light)"
      content="#f2f2f2"
    />
    <meta
      name="theme-color"
      media="(prefers-color-scheme: dark)"
      content="#24292e"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css"
    />
  </head>

  <body>
    <main>
      <button type="button" id="unit-btn" class="top-right-corner">...</button>
      <p id="status"></p>
      <p>Distance: <span id="distance"></span></p>
      <!-- <ol>
        <li>14</li>
        <li>15</li>
      </ol>
      <p>Average: 14m</p> -->
      <hr />
      <div class="center-content">
        <button type="button" id="start-btn">set start</button>
        <!-- <button type="button" id="">save</button>
        <button type="button" id="">reset</button> -->
      </div>
    </main>

    <style type="text/css">
      .center-content > * {
        margin: auto;
        display: block;
      }

      .top-right-corner {
        position: absolute;
        top: 1em;
        right: 1em;
      }

      /* .hidden {
        display: none;
      } */
    </style>

    <script src="/keep-screen-on.js" defer=""></script>

    <script>
      navigator.serviceWorker.register("/sw.js");

      /** Converts numeric degrees to radians */
      if (typeof Number.prototype.toRad === "undefined") {
        Number.prototype.toRad = function () {
          return (this * Math.PI) / 180;
        };
      }

      /** Converts string to number */
      if (typeof String.prototype.toNumber === "undefined") {
        String.prototype.toNumber = function () {
          const num = Number(this);
          return Number.isNaN(num) ? null : num;
        };
      }

      const status = document.querySelector("#status");
      const accuracy = document.querySelector("#accuracy");
      const distance = document.querySelector("#distance");
      const state = {
        get() {
          if (!this._state.tee.latitude || !this._state.tee.longitude) {
            const lat = sessionStorage.getItem("tee-latitude");
            const long = sessionStorage.getItem("tee-longitude");

            this._state.tee.latitude = lat?.toNumber() ?? undefined;
            this._state.tee.longitude = long?.toNumber() ?? undefined;
          }

          this._state.unit = localStorage.getItem("unit");

          return { ...this._state };
        },
        update(changes) {
          this._updateNestedObject(this._state, changes);

          if (this._state.tee.latitude && this._state.tee.longitude) {
            sessionStorage.setItem("tee-latitude", this._state.tee.latitude);
            sessionStorage.setItem("tee-longitude", this._state.tee.longitude);
          }

          if (changes.unit === "feet" || changes.unit === "meter") {
            localStorage.setItem("unit", changes.unit);
          }

          this._getPaths(changes).forEach((path) => {
            for (const pattern in this._observers) {
              if (this._matchPath(pattern, path)) {
                this._observers[pattern].forEach((listener) => {
                  listener(this.get());
                });
              }
            }
          });
        },
        _updateNestedObject(target, updates) {
          for (const key in updates) {
            if (typeof updates[key] === "object" && updates[key] !== null) {
              if (!target[key]) {
                target[key] = {};
              }
              this._updateNestedObject(target[key], updates[key]);
            } else {
              target[key] = updates[key];
            }
          }
        },
        _getPaths(obj, prefix = "") {
          const paths = [];

          for (const key in obj) {
            const path = prefix ? `${prefix}.${key}` : key;
            if (typeof obj[key] === "object" && obj[key] !== null) {
              paths.push(...this._getPaths(obj[key], path));
            } else {
              paths.push(path);
            }
          }

          return paths;
        },
        _matchPath(pattern, path) {
          const regex = new RegExp(
            "^" + pattern.replace("\.", "\\.").replace(/\*/g, ".*") + "$"
          );
          return regex.test(path);
        },
        _observers: {
          "current.accuracy": [updateAccuracy],
          "current.*": [updateDistance],
          "tee.*": [updateDistance],
          unit: [updateAccuracy, updateDistance],
        },
        _state: {
          unit: "meter",
          tee: {
            latitude: undefined,
            longitude: undefined,
          },
          current: {
            accuracy: undefined,
            latitude: undefined,
            longitude: undefined,
          },
        },
      };

      /**
       * Convert the distance from cm to feet or meter and add unit.
       * @param  {Number}  distance Distance in centimeters
       * @return {string}  Distance in the preferred unit with the unit attached
       */
      function getDistanceWithPreferredUnit(distance) {
        if (state.get().unit === "feet") {
          return `${Math.round(distance * 0.0328084)} feet`;
        } else {
          return `${Math.round(distance / 100)}m`;
        }
      }

      /**
       * Calculate distance using the haversine formula.
       * From https://stackoverflow.com/q/18883601
       * @param  {Object}  from The starting position
       * @param  {Object}  to   The ending position
       * @return {Number}  Distance in centimeters
       */
      function getDistanceBetween(from, to) {
        const R = 6371;
        const dLat = (to.latitude - from.latitude).toRad();
        const dLong = (to.longitude - from.longitude).toRad();

        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(from.latitude.toRad()) *
            Math.cos(to.latitude.toRad()) *
            Math.sin(dLong / 2) *
            Math.sin(dLong / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        const distance = R * c * 1000 * 100;
        return Math.round(distance);
      }

      /**
       * Update distance in the DOM
       * @param  {Object} state
       */
      function updateDistance(state) {
        if (!state.tee.latitude || !state.tee.longitude) {
          return;
        }
        const diff = getDistanceBetween(
          {
            latitude: state.tee.latitude,
            longitude: state.tee.longitude,
          },
          {
            latitude: state.current.latitude,
            longitude: state.current.longitude,
          }
        );
        distance.textContent = getDistanceWithPreferredUnit(diff);
      }

      /**
       * Update accuracy in the DOM
       * @param  {Object} state
       */
      function updateAccuracy(state) {
        const description = (() => {
          switch (true) {
            case state.current.accuracy < 550:
              return "good";
            case state.current.accuracy < 1050:
              return "decent";
            default:
              return "bad";
          }
        })();

        status.textContent = `Accuracy ${description}: ±${getDistanceWithPreferredUnit(
          state.current.accuracy
        )}`;
      }

      /**
       * Update the current position in the state object
       * @param  {Object}  position The current position
       */
      function updatePosition(position) {
        state.update({
          current: {
            accuracy: position.coords.accuracy * 100, // Save accuracy in cm to simplify conversions later
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
          },
        });
      }

      /**
       * Error when retrieve the position
       */
      function error() {
        status.textContent = "Unable to retrieve your location";
      }

      /**
       * Set the starting point to calculate distance from
       */
      function setStartPosition() {
        const currentState = state.get();
        if (currentState.current.latitude && currentState.current.longitude) {
          state.update({
            tee: {
              latitude: currentState.current.latitude,
              longitude: currentState.current.longitude,
            },
          });
        }
      }

      /**
       * Add "disabled"-attribute to the element for 750ms.
       */
      function disableBriefly(e) {
        const element = e.srcElement;
        element.setAttribute("disabled", true);
        setTimeout(() => {
          element.removeAttribute("disabled");
        }, 750);
      }

      function toggleUnit(e) {
        const btn = document.querySelector("#unit-btn");

        if (state.get().unit === "feet") {
          state.update({ unit: "meter" });
          btn.textContent = "feet";
        } else {
          state.update({ unit: "feet" });
          btn.textContent = "meter";
        }
      }

      if (!navigator.geolocation) {
        status.textContent = "Geolocation is not supported by your browser.";
      } else {
        status.textContent = "Locating…";
        const options = {
          enableHighAccuracy: true,
        };
        navigator.geolocation.watchPosition(updatePosition, error, options);
      }

      document
        .querySelector("#start-btn")
        .addEventListener("click", setStartPosition);

      document
        .querySelector("#start-btn")
        .addEventListener("click", disableBriefly);

      document.querySelector("#unit-btn").textContent = state.get().unit;
      document.querySelector("#unit-btn").addEventListener("click", toggleUnit);
    </script>
  </body>
</html>
